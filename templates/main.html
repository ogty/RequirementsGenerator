<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements.txt Generator</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.2/themes/default/style.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.2/jstree.min.js"></script>
</head>
<body>
    <h1>Requirements.txt Generator</h1>

    <form method="POST" onsubmit="return false;">
        <div class="select_language">
            <input type="radio" name="lang" value="python" checked>Python<br>
            <input type="radio" name="lang" value="julia">Julia
        </div>
        <div id="SimpleJSTree"></div>
        <button onclick="generate()">Generate</button>
    </form>

    <!-- show select now values -->
    <div id="select_now"></div>

    <!-- show message -->
    <div id="message"></div>
    <button onclick="value_reset()">Reset</button>

    <script>
        // Array to store the selected directory names.
        let dirs = [];

        // Asynchronous processing for JSON data acquisition
        $.ajax({
            type: "GET",
            // url: "{{ url_for('static', filename='tree.json') }}",
            url: "../static/tree.json",
            dataType: "json"
        })
        .then(
            function(json) {
                console.log("Success");
                createJSTree(json)
            },
            function() {
                console.log("Failure");
            }
        );

        // Clear the selected value.
        function value_reset() {
            dirs = [];
            $('#select_now').empty();
        }

        function createJSTree(jsondata) {
            $('#SimpleJSTree').jstree({
                'core': {
                    'data': jsondata["data"]
                },
            })
            .on('changed.jstree', function (e, data) {
                for(let i = 0; i < data.selected.length; i++) {
                    dirs.push(data.instance.get_node(data.selected[i]).text);
                }
                $('#select_now').empty();
                $('#select_now').append(dirs.join(','));
            })
        }

        // Function to send data to the backend(Main Function)
        function generate() {
            $.ajax("/generate", {
                type: "POST",
                data: {
                    "language": $("input:radio[name='lang']:checked").val(),
                    "dir_list": dirs.join(',')
                },
                dataType: "json",
            }).done(function(data) {
                const message = JSON.parse(data.values).message
                $("#message").html(message);
                console.log("Communication successful.");
            }).fail(function(data) {
                console.log("Communication failed.");
            });
        }
    </script>
</body>
</html>